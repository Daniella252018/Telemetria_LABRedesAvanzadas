import time
import serial
import mysql.connector
import collections
import broadlink

device = broadlink.hello('192.168.0.100')
device.auth()

arduino = serial.Serial(
        port='/dev/ttyACM0',
        baudrate = 9600,
        parity=serial.PARITY_NONE,
        stopbits=serial.STOPBITS_ONE,
        bytesize=serial.EIGHTBITS,
        timeout=1
)
print("Conectado por serial..")
arduino.flush()
temperatura=0
list_keepAlive = []
valor_25 = b'&\x00\xca\x00\x8b\x94\x0e9\x0e\x15\x0e9\x0f9\x0e\x15\x0e\x15\x0f9\x0e\x15\x0e\x15\x0e9\x0f\x15\x0e\x15\x0e9\x0f9\x0e\x15\x0e9\x0e:\x0e\x15\x0e9\x0e9\x0f9\x0e9\x0f8\x0f9\x0e\x15\x0e9\x0f\x15\x0e\x15\x0e\x15\x0e\x15\x0f\x15\x0e\x15\x0e9\x0e9\x0f\x15\x0e\x15\x0e\x15\x0e\x15\x0f\x15\x0e\x15\x0e\x15\x0e\x15\x0f9\x0e9\x0e9\x0f9\x0e9\x0e9\x0f\xae\x8d\x93\x0f9\x0e\x15\x0e9\x0f9\x0e\x15\x0e\x15\x0e9\x0f\x15\x0e\x15\x0e9\x0e\x15\x0f\x15\x0e9\x0e9\x0f\x15\x0e9\x0e9\x0f\x14\x0f9\x0e9\x0e9\x0f9\x0e9\x0e:\x0e\x15\x0e9\x0e\x15\x0f\x15\x0e\x15\x0e\x15\x0e\x15\x0e\x15\x0f9\x0e9\x0e\x15\x0f\x15\x0e\x15\x0e\x15\x0e\x15\x0f\x15\x0e\x15\x0e\x15\x0e9\x0f9\x0e9\x0e9\x0f9\x0e9\x0e\x00\r\x05'
valor_20 = b'&\x00\xca\x00\x8b\x93\x0f9\x0e\x15\x0e9\x0f9\x0e\x15\x0e\x15\x0e:\x0e\x15\x0e\x15\x0e9\x0f\x15\x0e\x15\x0e9\x0e9\x0f\x15\x0e9\x0e9\x0f\x15\x0e9\x0e9\x0f9\x0e9\x0e9\x0f9\x0e\x15\x0e9\x0f\x14\x0f\x15\x0e\x15\x0e\x15\x0e\x15\x0f\x15\x0e\x15\x0e\x15\x0e9\x0f\x15\x0e\x15\x0e\x15\x0e\x15\x0f\x15\x0e9\x0e9\x0f\x15\x0e9\x0e9\x0e:\x0e9\x0e9\x0e\xae\x8e\x93\x0e:\x0e\x15\x0e9\x0e9\x0f\x15\x0e\x15\x0e9\x0e\x15\x0f\x15\x0e9\x0e\x15\x0f\x14\x0f9\x0e9\x0e\x15\x0f9\x0e9\x0e\x15\x0f9\x0e9\x0e9\x0f9\x0e9\x0e9\x0f\x15\x0e9\x0e\x15\x0e\x15\x0f\x15\x0e\x15\x0e\x15\x0e\x15\x0e\x15\x0f\x15\x0e9\x0e\x15\x0f\x15\x0e\x15\x0e\x15\x0e\x15\x0e:\x0e9\x0e\x16\x0e8\x0f9\x0e9\x0e9\x0f9\x0e\x00\r\x05'
valor_17 = b'&\x00\xca\x00\x8c\x94\x0e9\x0e\x15\x0e9\x0f9\x0e\x15\x0e\x15\x0f9\x0e\x15\x0e\x15\x0e9\x0f\x15\x0e\x15\x0e9\x0e:\x0e\x15\x0e9\x0e9\x0f\x15\x0e9\x0e9\x0f9\x0e9\x0e9\x0f9\x0e\x15\x0e9\x0e\x15\x0f\x15\x0e\x15\x0e\x15\x0e\x15\x0f\x15\x0e\x15\x0e\x15\x0e\x15\x0f\x15\x0e\x15\x0e\x15\x0e\x15\x0f\x15\x0e9\x0e9\x0e9\x0f9\x0e9\x0e9\x0f9\x0e9\x0e\xae\x8e\x93\x0e:\x0e\x15\x0e9\x0e9\x0f\x15\x0e\x15\x0e9\x0e\x15\x0f\x15\x0e9\x0e\x15\x0f\x15\x0e9\x0e9\x0e\x15\x0f9\x0e9\x0e\x15\x0f9\x0e9\x0e9\x0f9\x0e9\x0e9\x0e\x15\x0f9\x0e\x15\x0e\x15\x0f\x15\x0e\x15\x0e\x15\x0e\x15\x0f\x14\x0f\x15\x0e\x15\x0e\x15\x0e\x15\x0f\x15\x0e\x15\x0e\x15\x0e9\x0f9\x0e9\x0e9\x0f9\x0e9\x0e9\x0f9\x0e\x00\r\x05'
valor_apagado = b'&\x00\xca\x00\x8b\x93\x0f9\x0e\x15\x0e9\x0e9\x0f\x15\x0e\x15\x0e9\x0f\x15\x0e\x15\x0e9\x0e\x15\x0f\x15\x0e9\x0e9\x0f\x14\x0f9\x0e\x15\x0e9\x0f9\x0e9\x0e9\x0f\x15\x0e9\x0e9\x0f9\x0e\x15\x0e\x15\x0e\x15\x0f\x15\x0e9\x0e\x15\x0e\x15\x0f9\x0e9\x0e9\x0f\x15\x0e\x15\x0e\x15\x0e\x15\x0e\x16\x0e\x15\x0e\x15\x0e\x15\x0e:\x0e9\x0e9\x0e:\x0e9\x0e\xae\x8e\x93\x0e9\x0e\x15\x0f9\x0e9\x0e\x15\x0f\x15\x0e9\x0e\x15\x0e\x15\x0f9\x0e\x15\x0e\x15\x0e:\x0e9\x0e\x15\x0e9\x0f\x15\x0e9\x0e9\x0f9\x0e9\x0e\x15\x0e:\x0e9\x0e9\x0e\x15\x0f\x15\x0e\x15\x0e\x15\x0e:\x0e\x15\x0e\x15\x0e9\x0f9\x0e9\x0e\x15\x0e\x15\x0f\x15\x0e\x15\x0e\x15\x0e\x15\x0f\x15\x0e\x15\x0e9\x0e:\x0e9\x0e9\x0e:\x0e\x00\r\x05'
valor_encendido = b'&\x00\xca\x00\x8b\x94\x0e9\x0e\x15\x0e9\x0f9\x0e\x15\x0e\x15\x0e:\x0e\x15\x0e\x15\x0e9\x0e\x15\x0f\x15\x0e9\x0e9\x0f\x15\x0e9\x0e9\x0e\x15\x0f9\x0e9\x0e9\x0f9\x0e9\x0e9\x0f\x15\x0e9\x0e\x15\x0e\x15\x0e\x16\x0e\x15\x0e\x15\x0e\x15\x0f\x15\x0e\x15\x0e\x15\x0e\x15\x0f\x15\x0e\x15\x0e\x15\x0e\x15\x0f9\x0e9\x0e9\x0f9\x0e:\r9\x0f9\x0e9\x0e\xae\x8e\x93\x0e9\x0f\x14\x0f9\x0e9\x0e\x15\x0f\x15\x0e9\r\x16\x0e\x15\x0f9\x0e\x15\x0e\x15\x0e:\x0e9\x0e\x15\x0e9\x0f9\x0e\x15\x0e9\x0f9\x0e9\x0e9\x0f9\x0e9\x0e\x15\x0f9\x0e\x15\r\x16\x0e\x15\x0e\x16\x0e\x15\x0e\x15\x0e\x15\x0e\x15\x0f\x15\x0e\x15\x0e\x15\x0e\x15\x0f\x15\x0e\x15\x0e9\x0e:\x0e9\x0e9\x0f9\x0e9\x0e9\x0e:\x0e\x00\r\x05'
on=0
off=0
try:
    while(1):
        try:
            if(arduino.in_waiting>0):
                temperatura=arduino.readline().decode('utf-8').rstrip()
                print(temperatura)
            connection = mysql.connector.connect(host='200.126.14.234',
                                                 port=5006,
                                                 user='gustavocastillo',
                                                 database='keepAlive',
                                                 password='temp123')
            mySql_insert_query = """INSERT INTO Temperatura (temperatura,fecha)
                                   VALUES
                                   ("""+str(temperatura)+""", now()) """
            select = "SELECT SERVIDOR_1, SERVIDOR_2, SERVIDOR_3, SERVIDOR_4, SERVIDOR_5, SERVIDOR_6, SERVIDOR_7, SERVIDOR_8 FROM keepAlive.pruebaestado ORDER BY estadoID DESC LIMIT 1; "
            cursor = connection.cursor()
            if(float(temperatura)!=0):
                cursor.execute(mySql_insert_query)
                cursor.execute(select)
                result = cursor.fetchall()
                #device.send_data(valor_20)
                #print(result[0])
                #print("result[0]=",type(result[0]))
                for d in result:
                    variable = collections.Counter(d)
                    valor_on = variable['Encendido']
                    valor_off = variable['Apagado']
                    temp=float(temperatura)
                    if (valor_on == 1 or valor_on == 2 ):
                        broadlinktemp = "INSERT INTO broadlink (temp, fecha) VALUES (25, now())"
                        cursor.execute(broadlinktemp)
                        if(temp<25.0):
                            device.send_data(valor_25)
                    elif(valor_on == 3 or valor_on == 4):
                        broadlinktemp = "INSERT INTO broadlink (temp, fecha) VALUES (20, now())"
                        cursor.execute(broadlinktemp)
                        if(temp>20.0):
                            device.send_data(valor_20)
                    elif(valor_on > 4):
                        broadlinktemp = "INSERT INTO broadlink (temp, fecha) VALUES (17, now())"
                        cursor.execute(broadlinktemp)
                        if(temp>17.0):
                            device.send_data(valor_17)
                    elif(valor_off == 8):
                        device.send_data(valor_apagado)
                connection.commit()
                print(cursor.rowcount, "Record inserted successfully into Temp")
                cursor.close()
        except mysql.connector.Error as error:
            print("Failed to insert record into Temperaturas table {}".format(error))
        time.sleep(5);
except(KeyboardInterrup,SystemExit):
    print("bye");
